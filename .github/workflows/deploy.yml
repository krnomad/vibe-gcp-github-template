name: deploy-cloud-run

on:
  push:
    branches:
      - main
  workflow_run:
    workflows:
      - ci-pr
    types:
      - completed

permissions:
  contents: read
  id-token: write
  pull-requests: read

jobs:
  deploy:
    if: >-
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Resolve deployment target
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
          EVENT_NAME: ${{ github.event_name }}
          RUN_PR_NUMBER: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.pull_requests[0].number || '' }}
        run: |
          set -euo pipefail

          if [[ "$EVENT_NAME" == "push" ]]; then
            echo "target_sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -z "$RUN_PR_NUMBER" ]]; then
            echo "No PR attached to workflow_run; skip deploy."
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for _ in {1..30}; do
            PR_JSON="$(gh pr view "$RUN_PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json mergedAt,baseRefName,mergeCommit --jq '{mergedAt,baseRefName,mergeCommit:(.mergeCommit.oid // "")}' )"
            MERGED_AT="$(jq -r '.mergedAt // ""' <<<"$PR_JSON")"
            BASE_REF="$(jq -r '.baseRefName' <<<"$PR_JSON")"
            MERGE_SHA="$(jq -r '.mergeCommit' <<<"$PR_JSON")"

            if [[ -n "$MERGED_AT" ]]; then
              if [[ "$BASE_REF" == "main" && -n "$MERGE_SHA" ]]; then
                echo "target_sha=$MERGE_SHA" >> "$GITHUB_OUTPUT"
                echo "should_deploy=true" >> "$GITHUB_OUTPUT"
              else
                echo "Merged PR base is not main; skip deploy."
                echo "should_deploy=false" >> "$GITHUB_OUTPUT"
              fi
              exit 0
            fi

            sleep 5
          done

          echo "PR merge not detected within wait window; skip deploy."
          echo "should_deploy=false" >> "$GITHUB_OUTPUT"

      - name: Checkout
        if: steps.resolve.outputs.should_deploy == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.target_sha }}

      - name: Authenticate to Google Cloud
        if: steps.resolve.outputs.should_deploy == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        if: steps.resolve.outputs.should_deploy == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        if: steps.resolve.outputs.should_deploy == 'true'
        run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push image
        if: steps.resolve.outputs.should_deploy == 'true'
        env:
          IMAGE_URI: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REPOSITORY }}/${{ vars.CLOUD_RUN_SERVICE }}:${{ steps.resolve.outputs.target_sha }}
        run: |
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> "$GITHUB_ENV"

      - name: Deploy Cloud Run
        if: steps.resolve.outputs.should_deploy == 'true'
        env:
          CLOUD_RUN_RUNTIME_SA: ${{ vars.CLOUD_RUN_RUNTIME_SA }}
          INSTANCE_CONNECTION_NAME: ${{ vars.INSTANCE_CONNECTION_NAME }}
          DB_NAME: ${{ vars.DB_NAME }}
          DB_USER: ${{ vars.DB_USER }}
          DB_PASSWORD_SECRET: ${{ vars.DB_PASSWORD_SECRET }}
        run: |
          set -euo pipefail

          DEPLOY_ARGS=(
            --project "${{ vars.GCP_PROJECT_ID }}"
            --region "${{ vars.GCP_REGION }}"
            --platform managed
            --image "$IMAGE_URI"
            --allow-unauthenticated
          )

          if [[ -n "$CLOUD_RUN_RUNTIME_SA" ]]; then
            DEPLOY_ARGS+=(--service-account "$CLOUD_RUN_RUNTIME_SA")
          fi

          if [[ -n "$INSTANCE_CONNECTION_NAME" ]]; then
            : "${DB_NAME:?DB_NAME GitHub variable is required when INSTANCE_CONNECTION_NAME is set}"
            : "${DB_USER:?DB_USER GitHub variable is required when INSTANCE_CONNECTION_NAME is set}"
            : "${DB_PASSWORD_SECRET:?DB_PASSWORD_SECRET GitHub variable is required when INSTANCE_CONNECTION_NAME is set}"
            DEPLOY_ARGS+=(--add-cloudsql-instances "$INSTANCE_CONNECTION_NAME")
            DEPLOY_ARGS+=(--set-env-vars "APP_ENV=prod,DB_NAME=$DB_NAME,DB_USER=$DB_USER,INSTANCE_CONNECTION_NAME=$INSTANCE_CONNECTION_NAME")
            DEPLOY_ARGS+=(--set-secrets "DB_PASSWORD=$DB_PASSWORD_SECRET:latest")
          else
            DEPLOY_ARGS+=(--set-env-vars "APP_ENV=prod")
          fi

          gcloud run deploy "${{ vars.CLOUD_RUN_SERVICE }}" "${DEPLOY_ARGS[@]}"
